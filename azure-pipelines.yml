# Docker image
# Build a Docker image to deploy, run, or push to a container registry.
# Add steps that use Docker Compose, tag images, push to a registry, run an image, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
- master
- dev
- bug/*

variables:
- group: my-variable-group
- name: imageName
  value: '$(Build.Repository.Name):latest'

jobs:
- job: build_pr
  pool:
    vmImage: 'Ubuntu-16.04'
  steps:
  - script: |
      ls -la
      echo "==============="
      git status
      echo "=================="
      git branch
      echo "================="
      git checkout $(System.PullRequest.SourceBranch)
      echo "================="
      git checkout $(System.PullRequest.TargetBranch)
      echo "================="
      git config --global user.email "sheeshmohsin@gmail.com"
      git config --global user.name "Sheesh Mohsin"
      git merge $(System.PullRequest.SourceBranch)
      echo "=================="
      echo $(Build.Repository.Name)
      echo $(Build.SourceBranch)
      echo $(Build.SourceBranchName)
      echo $(System.PullRequest.SourceBranch)
      echo $(System.PullRequest.TargetBranch)
      echo $(Build.Reason)
      echo $(SONAR_LOGIN)
      echo $(SONAR_PASS)
      echo $(DOCKER_USER)
      echo $(DOCKER_PASS)
      echo $(DOCKER_SERVER)

- job: build_branch
  pool:
    vmImage: 'Ubuntu-16.04'
  steps:
  - script: docker build -f Dockerfile -t $(imageName) .
    condition: eq(variables['Build.Reason'], 'PullRequest')
    displayName: 'docker build'
